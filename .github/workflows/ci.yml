name: CI - Build, Test, Scan, Push

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-scan:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    # 3Ô∏è‚É£ Upgrade build tools
    - name: Upgrade pip, setuptools, wheel
      run: |
        python -m pip install --upgrade pip setuptools wheel

    # 4Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: pip install -r requirements.txt

    # 5Ô∏è‚É£ Lint with Flake8
    - name: Lint code
      run: flake8 .

    # 6Ô∏è‚É£ Bandit security scan
    - name: Security scan with Bandit
      run: bandit -r .

    # 7Ô∏è‚É£ Run tests with coverage
    - name: Run tests
      run: pytest --cov=app --cov-fail-under=80

    # 8Ô∏è‚É£ Build Docker image
    - name: Build Docker image
      run: docker build -t user-manager:latest .

    # 9Ô∏è‚É£ Scan Docker image with Trivy
    - name: Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@v1
      with:
        image-ref: user-manager:latest
        severity: HIGH,CRITICAL
        exit-code: 1

    # üîü Docker Hub login
    - name: Docker Hub login
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
      run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

    # 1Ô∏è‚É£1Ô∏è‚É£ Tag and push Docker image
    - name: Tag and push Docker image
      run: |
        docker tag user-manager:latest docker.io/${{ secrets.DOCKER_USER }}/user-manager:latest
        docker push docker.io/${{ secrets.DOCKER_USER }}/user-manager:latest
